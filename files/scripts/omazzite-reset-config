#!/bin/bash
set -euo pipefail

# --- Configuration ---
SKEL_DIR="/etc/skel"
CONFIG_TARGETS=(
    ".bashrc"
    ".XCompose"
    ".config/omadora"
    ".config/btop"
    ".config/hypr"
    ".config/mako"
    ".config/nvim"
    ".config/uwsm"
    ".config/waybar"
    ".local/share/applications/icons"
    ".local/share/fonts"
    ".local/share/omadora"
)

# --- Main Script ---
echo "--- Omazzite Configuration Reset Tool ---"
echo
echo "This will reset your desktop environment's config to factory defaults."
echo "Your current settings will be backed up."
echo
echo "The following will be reset:"
for target in "${CONFIG_TARGETS[@]}"; do
    echo "  - ~/$target"
done
echo "  - GTK/Icon Theme Settings"
echo
echo "Your other personal files and application settings will NOT be touched."
echo

read -p "Are you sure you want to continue? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Reset cancelled."
    exit 0
fi

TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
BACKUP_DIR="$HOME/.config/omadora-backup-$TIMESTAMP"
mkdir -p "$BACKUP_DIR"
echo "Creating backup of current configuration in: $BACKUP_DIR"

for target in "${CONFIG_TARGETS[@]}"; do
    source_path="$HOME/$target"
    if [ -e "$source_path" ]; then
        echo "Backing up ~/$target..."
        mkdir -p "$(dirname "$BACKUP_DIR/$target")"
        mv "$source_path" "$BACKUP_DIR/$target"
    fi
done

echo "Backup complete. Restoring default files and directories..."
if ! cp -aT "$SKEL_DIR/" "$HOME/"; then
    echo "Error: Failed to copy files from $SKEL_DIR."
    echo "Your old configuration has been saved in $BACKUP_DIR."
    exit 1
fi

echo "Restoring default GTK/GNOME theme settings..."
# These commands target the user's dconf database to reset themes without
# wiping settings for other applications.
gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
gsettings set org.gnome.desktop.interface color-scheme "prefer-dark"
gsettings set org.gnome.desktop.interface icon-theme "Yaru-blue"

echo "Ensuring essential user services are enabled..."
systemctl --user enable --now omadora-first-login.service > /dev/null 2>&1 || true
systemctl --user enable --now omadora-battery-monitor.timer > /dev/null 2>&1 || true

echo
echo "âœ… Reset complete!"
echo "Your previous configuration is backed up in: $BACKUP_DIR"
echo "Please log out and log back in for all changes to take effect."

exit 0
